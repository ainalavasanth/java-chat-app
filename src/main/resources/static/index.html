<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VASApp Secure</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #00a884; --bg-dark: #0b141a; --bg-panel: #202c33; --incoming: #202c33; --outgoing: #005c4b; --text: #e9edef; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }

        /* AUTH SCREEN */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .auth-card { background: var(--bg-panel); padding: 2rem; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .auth-card h2 { color: var(--primary); margin-bottom: 20px; }
        
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 1px solid #374045; }
        .tab { padding: 10px 20px; cursor: pointer; color: #8696a0; width: 50%; }
        .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); font-weight: bold; }
        
        .form-group input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #374045; background: #2a3942; color: white; }
        .auth-btn { width: 100%; padding: 12px; background: var(--primary); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .error-msg { color: #ff4d4d; font-size: 0.8rem; margin-top: 10px; display: none; }

        /* APP STYLES (Same as before) */
        #app-container { display: none; flex: 1; flex-direction: column; height: 100%; max-width: 900px; margin: 0 auto; width: 100%; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; }
        .header { background: var(--bg-panel); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .header-title { font-weight: bold; font-size: 1.1rem; }
        .icon-btn-head { background: none; border: none; color: #8696a0; font-size: 1.2rem; cursor: pointer; margin-left: 15px; }
        
        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .message-row { display: flex; width: 100%; }
        .message-row.me { justify-content: flex-end; }
        .bubble { max-width: 80%; padding: 8px 10px; border-radius: 10px; font-size: 0.95rem; background: var(--incoming); position: relative; min-width: 80px; }
        .me .bubble { background: var(--outgoing); }
        .sender { font-size: 0.7rem; color: #d69a43; font-weight: bold; display: block; margin-bottom: 2px; }
        .footer { background: var(--bg-panel); padding: 8px 10px; display: flex; align-items: center; gap: 8px; }
        .footer input { flex: 1; padding: 12px 15px; border-radius: 20px; border: none; background: #2a3942; color: white; font-size: 1rem; }
        .icon-btn { background: none; border: none; color: #8696a0; font-size: 1.4rem; cursor: pointer; padding: 5px; }
        
        /* Popups */
        #call-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; }
        .call-btn { width: 65px; height: 65px; border-radius: 50%; border: none; color: white; font-size: 1.8rem; cursor: pointer; margin: 0 15px; }
        .btn-accept { background: #00a884; } .btn-reject { background: #ff4d4d; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2>VASApp Secure</h2>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('login')">Login</div>
                <div class="tab" onclick="switchTab('register')">Register</div>
            </div>

            <div id="login-form" class="form-group">
                <input type="text" id="login-user" placeholder="Username">
                <input type="password" id="login-pass" placeholder="Password">
                <input type="password" id="login-code" placeholder="Group PIN (for encryption)">
                <button class="auth-btn" onclick="doLogin()">Login</button>
            </div>

            <div id="register-form" class="form-group" style="display:none;">
                <input type="text" id="reg-user" placeholder="Choose Username">
                <input type="password" id="reg-pass" placeholder="Choose Password">
                <input type="text" id="reg-group" placeholder="Group Name (e.g. Family)">
                <button class="auth-btn" onclick="doRegister()">Create Account</button>
            </div>
            
            <p id="auth-error" class="error-msg">Error message here</p>
        </div>
    </div>

    <div id="app-container">
        <div class="header">
            <div>
                <div class="header-title" id="header-title">Group</div>
                <div style="font-size:0.8rem; color:var(--primary)" id="status-text">...</div>
            </div>
            <div>
                <button class="icon-btn-head" onclick="startCall()"><i class="fas fa-phone"></i></button>
                <button class="icon-btn-head" onclick="clearChat()"><i class="fas fa-trash"></i></button>
                <button class="icon-btn-head" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        
        <div id="chat-area"></div>

        <div class="footer">
            <input type="file" id="file-input" style="display:none;" onchange="handleFileSelect(event)">
            <button class="icon-btn" onclick="document.getElementById('file-input').click()"><i class="fas fa-paperclip"></i></button>
            <input type="text" id="message-input" placeholder="Type a message" onkeypress="handleEnter(event)">
            <button class="icon-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="call-modal">
        <h3 id="call-status" style="color:white; margin-bottom:30px;">Incoming Call...</h3>
        <div style="display:flex;">
            <button class="call-btn btn-reject" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
            <button class="call-btn btn-accept" id="accept-btn" onclick="acceptCall()"><i class="fas fa-phone"></i></button>
        </div>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <script>
        let stompClient = null;
        let username, roomCode, groupName;
        const myId = "u_" + Date.now();
        
        // --- AUTH LOGIC ---
        function switchTab(tab) {
            document.getElementById('auth-error').style.display = 'none';
            if(tab === 'login') {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.querySelectorAll('.tab')[1].classList.remove('active');
            } else {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
                document.querySelectorAll('.tab')[0].classList.remove('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
            }
        }

        async function doRegister() {
            const user = document.getElementById('reg-user').value;
            const pass = document.getElementById('reg-pass').value;
            const group = document.getElementById('reg-group').value;

            if(!user || !pass || !group) return showError("All fields required");

            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass, groupName: group })
                });
                const txt = await res.text();
                if(res.ok) {
                    alert("Registration Successful! Please Login.");
                    switchTab('login');
                } else {
                    showError(txt);
                }
            } catch(e) { showError("Server Error"); }
        }

        async function doLogin() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const pin = document.getElementById('login-code').value;

            if(!user || !pass) return showError("Enter Username & Password");

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });
                
                if(res.ok) {
                    const data = await res.json();
                    // Login Success
                    username = data.username;
                    groupName = data.groupName;
                    roomCode = pin || "default"; // Pin is local only for encryption
                    
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-container').style.display = 'flex';
                    document.getElementById('header-title').innerText = groupName;
                    
                    connect(); // Start WebSocket
                } else {
                    showError("Invalid Credentials");
                }
            } catch(e) { showError("Server Error"); }
        }

        function showError(msg) {
            const err = document.getElementById('auth-error');
            err.innerText = msg;
            err.style.display = 'block';
        }

        function logout() { location.reload(); }

        // --- WEBSOCKET & CHAT LOGIC (Same as before) ---
        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;
            stompClient.connect({}, () => {
                stompClient.subscribe('/topic/public', onMessageReceived);
                stompClient.subscribe('/topic/history/' + myId, onHistoryReceived);
                sendPayload("JOINED", 'JOIN');
            });
        }

        function sendPayload(content, type, extra={}) {
            const msg = {
                messageId: 'msg_' + Date.now(),
                from: username,
                text: (type === 'VOICE' || type.length < 10) ? content : encrypt(content),
                type: type,
                senderId: myId,
                groupName: groupName,
                ...extra
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(msg));
        }

        function onMessageReceived(payload) {
            const msg = JSON.parse(payload.body);
            if(msg.groupName && msg.groupName !== groupName) return;
            if(msg.onlineCount) document.getElementById('status-text').innerText = msg.onlineCount + " Online";
            if(msg.type === 'CLEAR') { document.getElementById('chat-area').innerHTML = ''; return; }
            // Basic render
            if(msg.type === 'CHAT' || msg.type === 'VOICE' || msg.type === 'JOIN') renderMessage(msg);
        }
        function onHistoryReceived(p) { renderMessage(JSON.parse(p.body)); }

        function renderMessage(msg) {
            if(document.getElementById(msg.messageId)) return;
            const div = document.createElement('div');
            const isMe = msg.from === username;
            
            let content = decrypt(msg.text) || msg.text;
            if(msg.type === 'JOIN') {
                div.innerHTML = `<div style="text-align:center;margin:10px;color:#888;font-size:0.8rem;">${msg.from} joined</div>`;
                document.getElementById('chat-area').appendChild(div);
                return;
            }
            if(msg.type === 'VOICE') content = `<audio controls src="${msg.text}"></audio>`;

            div.className = `message-row ${isMe ? 'me' : 'other'}`;
            div.innerHTML = `<div class="bubble" id="${msg.messageId}">
                <span class="sender">${msg.from}</span>
                <span>${content}</span>
            </div>`;
            
            // Add style dynamically for rows if missing in this snippet
            div.style.display = "flex";
            div.style.width = "100%";
            div.style.justifyContent = isMe ? "flex-end" : "flex-start";
            div.style.marginBottom = "10px";

            document.getElementById('chat-area').appendChild(div);
            document.getElementById('chat-area').scrollTop = 10000;
        }

        // Utils
        function encrypt(t) { return CryptoJS.AES.encrypt(t, roomCode).toString(); }
        function decrypt(t) { try{return CryptoJS.AES.decrypt(t, roomCode).toString(CryptoJS.enc.Utf8);}catch(e){return"";} }
        function sendMessage() { const el=document.getElementById('message-input'); if(el.value){sendPayload(el.value,'CHAT'); el.value="";} }
        function handleEnter(e) { if(e.key==='Enter')sendMessage(); }
        function clearChat() { if(prompt("PIN?")==="1234") sendPayload("1234", "CLEAR"); }
        // (Add Mic/Call logic from previous steps here if needed, kept short for auth focus)
    </script>
</body>
</html>