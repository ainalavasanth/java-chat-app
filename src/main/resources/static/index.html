<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VASApp</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #00a884;
            --bg-dark: #0b141a;
            --bg-panel: #202c33;
            --incoming: #202c33;
            --outgoing: #005c4b;
            --text: #e9edef;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-card { background: var(--bg-panel); padding: 2rem; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .logo-text { font-size: 2rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block;}
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { font-size: 0.8rem; color: #8696a0; margin-left: 5px; }
        .login-card input { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #374045; background: #2a3942; color: white; font-size: 1rem;}
        .login-card button { width: 100%; padding: 12px; background: var(--primary); border: none; border-radius: 8px; color: black; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem;}

        /* App */
        #app-container { display: none; flex: 1; flex-direction: column; height: 100%; max-width: 900px; margin: 0 auto; width: 100%; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; }
        
        .header { background: var(--bg-panel); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 10; }
        .header-title { font-weight: bold; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;}
        .header-subtitle { font-size: 0.8rem; color: var(--primary); margin-top: 2px; font-weight: bold;}
        .header-actions { display: flex; gap: 15px; }
        .icon-btn-head { background: none; border: none; color: #8696a0; font-size: 1.1rem; cursor: pointer; }
        
        /* Typing Indicator */
        #typing-indicator { position: absolute; bottom: 70px; left: 20px; background: rgba(32, 44, 51, 0.9); padding: 5px 10px; border-radius: 10px; font-size: 0.75rem; color: var(--primary); display: none; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message-row { display: flex; width: 100%; }
        .message-row.me { justify-content: flex-end; }
        .bubble { max-width: 80%; padding: 8px 10px; border-radius: 10px; font-size: 0.95rem; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.2); word-wrap: break-word; }
        .me .bubble { background-color: var(--outgoing); border-top-right-radius: 0; }
        .other .bubble { background-color: var(--incoming); border-top-left-radius: 0; }
        .sender { font-size: 0.7rem; color: #d69a43; font-weight: bold; display: block; margin-bottom: 3px; }
        .time { font-size: 0.65rem; color: rgba(255,255,255,0.6); text-align: right; margin-top: 2px; float: right; margin-left: 8px;}
        
        .bubble img, .bubble video { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; cursor: pointer; }
        .file-link { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-decoration: none; color: white; margin-top: 5px; }

        .footer { background: var(--bg-panel); padding: 8px 10px; display: flex; align-items: center; gap: 8px; }
        .footer input { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; background: #2a3942; color: white; font-size: 1rem;}
        .icon-btn { background: none; border: none; color: #8696a0; font-size: 1.4rem; cursor: pointer; padding: 5px; }
        #send-btn { background: var(--primary); color: black; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;}
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <span class="logo-text">VASApp</span>
            
            <div class="input-group">
                <label>Group Name</label>
                <input type="text" id="group-in" placeholder="e.g. Family, Office, Trip" autocomplete="off">
            </div>

            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="username-in" placeholder="e.g. Bhavya" autocomplete="off">
            </div>

            <div class="input-group">
                <label>Room Code (Pin)</label>
                <input type="password" id="code-in" placeholder="****" autocomplete="off">
            </div>

            <button onclick="attemptLogin()">Enter VASApp</button>
        </div>
    </div>

    <div id="app-container">
        <div class="header">
            <div>
                <div class="header-title" id="header-title">VASApp Group</div>
                <div class="header-subtitle" id="status-text">Connecting...</div>
            </div>
            <div class="header-actions">
                <button class="icon-btn-head" onclick="clearChat()" title="Clear Chat"><i class="fas fa-trash"></i></button>
                <button class="icon-btn-head" onclick="logout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div id="chat-area">
            <div style="text-align:center; margin-top:20px; margin-bottom:20px;">
                <span style="background:#1c272d; color:#ffd279; padding:8px 15px; border-radius:10px; font-size:0.75rem; box-shadow: 0 1px 1px rgba(0,0,0,0.2);">
                    <i class="fas fa-lock"></i> Messages are end-to-end encrypted.
                </span>
            </div>
        </div>

        <div id="typing-indicator">Someone is typing...</div>

        <div class="footer">
            <input type="file" id="file-input" style="display: none;" onchange="handleFileSelect(event)">
            <button class="icon-btn" onclick="document.getElementById('file-input').click()"><i class="fas fa-paperclip"></i></button>
            <input type="text" id="message-input" placeholder="Message" onkeypress="handleEnter(event)" oninput="notifyTyping()">
            <button id="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        let stompClient = null;
        let username = null;
        let roomCode = null;
        let groupName = null;
        const myId = "user_" + Math.floor(Math.random() * 1000000);
        let typingTimeout = null;

        // --- Auto Login Logic ---
        window.onload = function() {
            const savedUser = localStorage.getItem("vas_user");
            const savedCode = localStorage.getItem("vas_code");
            const savedGroup = localStorage.getItem("vas_group");
            
            if(savedUser && savedCode && savedGroup) {
                username = savedUser;
                roomCode = savedCode;
                groupName = savedGroup;
                connect();
            }
        };

        function attemptLogin() {
            username = document.getElementById('username-in').value.trim();
            roomCode = document.getElementById('code-in').value.trim();
            groupName = document.getElementById('group-in').value.trim();

            if(!username || !roomCode || !groupName) return alert("All fields are required!");
            
            // Save everything
            localStorage.setItem("vas_user", username);
            localStorage.setItem("vas_code", roomCode);
            localStorage.setItem("vas_group", groupName);
            
            connect();
        }

        function logout() {
            localStorage.removeItem("vas_user");
            localStorage.removeItem("vas_code");
            localStorage.removeItem("vas_group");
            location.reload();
        }

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null; 

            stompClient.connect({}, () => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                
                // SET THE GROUP NAME IN HEADER
                document.getElementById('header-title').innerText = groupName;

                stompClient.subscribe('/topic/public', onMessageReceived);
                stompClient.subscribe('/topic/history/' + myId, onMessageReceived);
                
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({ 
                    from: username, text: encrypt("JOIN"), type: 'JOIN', senderId: myId 
                }));
            }, (err) => {
                console.error(err);
            });
        }

        // --- Typing Logic ---
        function notifyTyping() {
            if(stompClient) {
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                    from: username, type: 'TYPING'
                }));
            }
        }

        function showTyping(sender) {
            const indicator = document.getElementById('typing-indicator');
            indicator.innerText = sender + " is typing...";
            indicator.style.display = 'block';
            if(typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => { indicator.style.display = 'none'; }, 2000);
        }

        // --- Encryption ---
        function encrypt(data) { return CryptoJS.AES.encrypt(data, roomCode).toString(); }
        function decrypt(data) {
            try {
                const bytes = CryptoJS.AES.decrypt(data, roomCode);
                const original = bytes.toString(CryptoJS.enc.Utf8);
                return original || null;
            } catch(e) { return null; }
        }

        // --- Messaging ---
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(text) {
                sendPayload(text);
                input.value = '';
                input.focus();
            }
        }

        function sendPayload(content) {
            if(stompClient) {
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                    from: username, text: encrypt(content), type: 'CHAT', senderId: myId
                }));
            }
        }

        function onMessageReceived(payload) {
            const msg = JSON.parse(payload.body);
            const chatArea = document.getElementById('chat-area');

            // Online Count
            if (msg.onlineCount > 0) {
                document.getElementById('status-text').innerText = msg.onlineCount + " Online";
            }

            // Typing
            if (msg.type === 'TYPING') {
                if (msg.from !== username) showTyping(msg.from);
                return;
            }

            // Clear
            if (msg.type === 'CLEAR') {
                chatArea.innerHTML = `<div style="text-align:center; margin:20px;"><span style="background:#ef4444; color:white; padding:5px 10px; border-radius:10px; font-size:0.7rem;">Chat Cleared</span></div>`;
                return;
            }

            const content = decrypt(msg.text);
            if(content === null) return; 

            const div = document.createElement('div');

            if(msg.type === 'JOIN' || msg.type === 'LEAVE') {
                if(msg.from !== username) {
                    div.innerHTML = `<div style="text-align:center; margin:10px;"><span style="background:#1c272d; padding:5px 10px; border-radius:10px; font-size:0.75rem; color:#8696a0;">${msg.from} ${msg.type === 'JOIN' ? 'joined' : 'left'}</span></div>`;
                    chatArea.appendChild(div);
                }
            } else {
                const isMe = msg.from === username;
                let bubbleContent = `<span>${content}</span>`;

                if (content.startsWith("data:image")) bubbleContent = `<img src="${content}" onclick="openMedia(this.src)">`;
                else if (content.startsWith("data:video")) bubbleContent = `<video src="${content}" controls></video>`;
                else if (content.startsWith("data:")) bubbleContent = `<a href="${content}" download="file" class="file-link"><i class="fas fa-file"></i> File</a>`;

                div.className = `message-row ${isMe ? 'me' : 'other'}`;
                div.innerHTML = `<div class="bubble"><span class="sender">${msg.from}</span>${bubbleContent}<div class="time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div></div>`;
                chatArea.appendChild(div);
            }
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function handleFileSelect(e) { 
            const reader = new FileReader();
            reader.onload = function(ev) { sendPayload(ev.target.result); };
            reader.readAsDataURL(e.target.files[0]); 
        }
        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
        function clearChat() { if(confirm("Clear chat history?")) stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({ from: username, type: 'CLEAR' })); }
        function openMedia(src) { const w = window.open(""); w.document.write('<body style="background:black;margin:0;display:flex;align-items:center;justify-content:center;height:100vh;"><img src="'+src+'" style="max-width:100%"></body>'); }
    </script>
</body>
</html>